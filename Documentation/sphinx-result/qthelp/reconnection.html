
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Reconnection</title>
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="next" title="Support" href="support.html" />
    <link rel="prev" title="Running" href="running.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="index.html">
          <span>CanModule 1.1.9.7 documentation</span></a></h1>
        <h2 class="heading"><span>Reconnection</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="running.html">Running</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="support.html">Support</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="reconnection">
<h1>Reconnection</h1>
<p>CanModule tries to recuperate lost connections automatically, but presently there is no method
to interrogate CanModule on the status of it’s connected modules. This might be added later, though.
There are up to four ways how to loose a connection, depending on the vendor and type of the module:</p>
<ol class="arabic simple">
<li>power loss</li>
<li>network or USB loss/interruption</li>
<li>firmware or “full” module reset through API</li>
<li>software close/open CAN bus WITHOUT reloading the library.</li>
</ol>
<p>in short: please avoid (4) and reload the library if possible.</p>
<div class="section" id="anagate">
<h2>anagate</h2>
<p>The anagate modules are easily and uniquely identified by their IP address, also several modules
per CanModule instance are straightforward. The firmware reset (3) is NOT implemented in the CanModule,
but a module can be remotely accessed and firmware reset using the vendor API, through code like:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">AnaInt32</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">12000</span><span class="p">;</span> <span class="c1">// 12secs</span>
<span class="n">AnaInt32</span> <span class="n">anaRet</span> <span class="o">=</span> <span class="n">CANRestart</span><span class="p">(</span> <span class="s">&quot;192.168.1.10&quot;</span><span class="p">,</span> <span class="n">timeout</span> <span class="p">);</span>
</pre></div>
</div>
<p>In the cases (1),(2) CanModule detects a failure to send a message on a port, and tries to reconnect
all ports of that module. Sending messages are buffered for ~20secs, and the reconnection
takes at least ~20sec, so it takes ~1 minute to reestablish communication. All received CAN frames
are lost, and not all sent frames are guaranteed, therefore some care has to be taken when the
connection is reestablished concerning the statuses of CAN slaves. CanModule reports reconnections
as warnings, but there is no systematic CanModule-API yet to handle reconnections
systematically (is it needed?).</p>
<p>The anagate duo reconnects somewhat faster than the X4/X8 modules, because of firmware differences.
The whole reconnection can take up to 60 secs until all buffers are cleared, so please be patient.</p>
<p>The case (4), software close/open, leads to a deallocation of the connection object, followed by a newly
created connection. These objects are recorded in a (anagate-global) connection map. The library
load object (see standard API) can also be deallocated and recreated, but it may also be reused.
Although the library does not need to be reloaded, strictly speaking, it is recommended to reload it
before a (re-)connect:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span>        <span class="n">libloader</span> <span class="o">=</span> <span class="n">CanModule</span><span class="o">::</span><span class="n">CanLibLoader</span><span class="o">::</span><span class="n">createInstance</span><span class="p">(</span> <span class="s">&quot;an&quot;</span> <span class="p">);</span>
<span class="n">cca</span> <span class="o">=</span> <span class="n">libloader</span><span class="o">-&gt;</span><span class="n">openCanBus</span><span class="p">(</span> <span class="s">&quot;an:can0:xxx.xxx.xxx.xxx&quot;</span><span class="p">,</span> <span class="s">&quot;125000 0 0 0 0&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>WARNING: the Anagate modules tend to firmware-crash if too many CAN bus software close/open are
executed too quickly, making a full power-cycle of the module necessary. A delay of 7 seconds
between a close and a (re-)open per module is therefore imposed by CanModule to avoid
“firmware-crashing” of the anagate module. This crash occurs independently from the connection
timeout.</p>
<p>A bigger delay is recommended if it can be afforded: lab-tests show a 7sec delay still crashes
after 30 consecutive reconnects. These crashes can also be related to networking problems but
they are difficult to fix.</p>
</div>
<div class="section" id="peak">
<h2>peak</h2>
<div class="section" id="linux-cc7">
<h3>linux/cc7</h3>
<ul class="simple">
<li>power loss is recuperated correctly: the module is receiving power through the USB port,</li>
</ul>
<p>if this connection is lost we need to reconnect. Reconnection works for both normal (fixed)
and flexible datarate (FD) modules under linux, as socketcan is used.
- Reconnection takes less than 30sec.
- A software close/open is fully supported and works under cc7 without limitations.</p>
</div>
<div class="section" id="windows">
<h3>windows</h3>
<ul class="simple">
<li>power loss is recuperated correctly, but only normal datarate (fixed) are supported</li>
<li>the sw close/open will typically work several times, and CanModule tries to</li>
</ul>
<p>recuperate from a failed initialisation of the USB 10 times. Between successive attempts on a
given port a delay of several seconds is needed. This is not great, maybe further progress
can be made later.</p>
</div>
</div>
<div class="section" id="systec">
<h2>systec</h2>
<div class="section" id="id1">
<h3>linux/cc7</h3>
<ul class="simple">
<li>A power loss or a connection loss will trigger a reconnection. For linux, where socketcan is used,</li>
</ul>
<p>this works in the same way as for peak. Connections are managed in a global map.
- A software close/open is fully supported and works under cc7 and also windows without limitations.
If the sequence is too fast (for the environment..) some messages will be lost, but the
module recuperates correctly in the following.</p>
</div>
<div class="section" id="id2">
<h3>windows</h3>
<ul class="simple">
<li>the hardware reconnection is NOT WORKING, and it is not clear if it can actually</li>
</ul>
<p>be achieved within CanModule. It seems that a library reload is needed to make the module work again.
This feature is therefore DROPPED for now, since also no strong user request for “systec reconnection
under windows” is presently stated. I tried, using the systec <a class="reference external" href="mailto:API&#37;&#52;&#48;windows">API<span>&#64;</span>windows</a> as documented, but did not manage.</p>
<ul class="simple">
<li>the software close/open works correctly, some messages can be lost.</li>
</ul>
</div>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="running.html">Running</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="support.html">Support</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, CERN, BE-ICS (Michael Ludwig).
      Last updated on 07-Aug-2020 08:37:25.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.5.
    </div>
  </body>
</html>