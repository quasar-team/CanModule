variables:
  ALMA_LATEST_IMAGE: "gitlab-registry.cern.ch/quasar-team/images/alma-10-build:latest"
  WINDOWS_LATEST_IMAGE: "gitlab-registry.cern.ch/quasar-team/images/win2025-build:latest"

Compile on Windows:
  stage: unstagged
  image: $WINDOWS_LATEST_IMAGE
  tags:
    - win2025-container
  script:
    - cmake -B build
    - cmake --build build --config Release
  artifacts:
    paths:
      - build/
    when: always

Compile on Linux:
  stage: unstagged
  image: $ALMA_LATEST_IMAGE
  script:
    - cmake -B build
    - cmake --build build --config Release
  artifacts:
    paths:
      - build/
    when: always

Compile on Linux (local ANAGATE archive):
  stage: unstagged
  image: $ALMA_LATEST_IMAGE
  script:
    - 'curl --fail --location --header "PRIVATE-TOKEN: ${ICS_REPO_DEPS_TOKEN}" -o /tmp/anagate.zip "https://ics-deps-repo.web.cern.ch/canmodule/anagate/20241023/AnaGateAPI-CAN-2.5-BETA-3.zip"'
    - cmake -B build-anagate-local -DANAGATE_LIBRARY=/tmp/anagate.zip
    - cmake --build build-anagate-local --config Release

Compile on Windows (local ANAGATE archive):
  stage: unstagged
  image: $WINDOWS_LATEST_IMAGE
  tags:
    - win2025-container
  script:
    - $anagateZip = Join-Path $env:TEMP 'anagate.zip'
    - Invoke-WebRequest -Headers @{ 'PRIVATE-TOKEN' = $env:ICS_REPO_DEPS_TOKEN } -OutFile $anagateZip -Uri 'https://ics-deps-repo.web.cern.ch/canmodule/anagate/20241023/AnaGateAPI-CAN-2.5-BETA-3.zip'
    - cmake -B build-anagate-local "-DANAGATE_LIBRARY=$anagateZip"
    - cmake --build build-anagate-local --config Release

Google Tests on Windows:
  stage: unstagged
  image: $WINDOWS_LATEST_IMAGE
  tags:
    - win2025-container
  needs:
    - Compile on Windows
  script:
    - ctest --test-dir build

Google Tests on Linux:
  stage: unstagged
  image: $ALMA_LATEST_IMAGE
  needs:
    - Compile on Linux
  script:
    - ctest --test-dir build

Pytest on Windows:
  stage: unstagged
  image: $WINDOWS_LATEST_IMAGE
  tags:
    - win2025-container
  needs:
    - Compile on Windows
  script:
    - python -m pytest

Pytest on Linux:
  stage: unstagged
  tags:
    - linux-socketcan
  needs:
    - Compile on Linux
  script:
    - python -m pytest


Run Sanity Checks:
  stage: unstagged
  image: $ALMA_LATEST_IMAGE
  script:
    - pip install pre-commit
    - pre-commit run --all-files

Update Documentation Website:
  stage: unstagged
  image: $ALMA_LATEST_IMAGE
  script:
    - |
      curl -X POST \
           --fail \
           -F token=$DOC_TOKEN \
           -F "ref=master" \
           -F "variables[DOCUMENTATION_GENERATION]=true" \
           https://gitlab.cern.ch/api/v4/projects/$CI_PROJECT_ID/trigger/pipeline
